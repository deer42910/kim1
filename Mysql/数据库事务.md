数据库事务

**概述：**是一套操作数据命令的有序集合，一个不可分割的工作单位。

事务中的单个命令不会立即改变数据库数据，当内部全部命令执行成功，统一更新数据，当有任一命令失败，可以进行状态回滚。

**作用**：

1. 为数据库操作序列提供了一个从失败中恢复到正常状态的方法，
2. 当多个应用程序在并发访问数据库时，以防止彼此的操作互相干扰

例如：执行一个SQL脚本时，如果脚本的某些部分失败，事务管理系统会撤销之前成功的操作，保证数据库不会处于半完成的状态。这样做的目的是为了确保数据库的状态在任何时候都保持一致。

程序场景：一个转账事务 发起者-钱 接收者+钱  只有都成功才会成功，一个失败返回原状态。

**ACID特征**

**原子性（Automicity）**

  原子性是指事务是一个不可分割的工作单位，事务中的操作要么都发生，要么都不发生。

**一致性（Consistency）**

  事务内部的操作的状态前后一致,成功都成功,失败都失败,避免部分成功出现错误数据。

**隔离性（Isolation）**

  事务的隔离性是指一个事务的执行不能被其他事务干扰，即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

**持久性（Durability）**

  持久性是指一个事务一旦被提交，它对数据库中数据的改变就是永久性的，接下来的其他操作和数据库故障不应该对其有任何影响

**事务的开启、提交、回滚**

MySQL默认情况下是自动提交事务

每一条语句都是一个事务，一旦成功就提交了，一条失败，单独一条语句不生效；将多条语句加入到一个事务中。

```
方案一：事务手动提交
#手动提交
SET autocommit = 0 | FALSE
#自动提交
SET autocommit = 0 | TRUE |每次新建连接默认都是自动提交
#查看是否自动提交
SHOW VARIABLES LIKE 'autocommit';
注意：每次新建连接都是默认值 自动提交 都需要主动设置一下
```

事务以开启，退出重新连，还是回到默认值

![image-20240908160000531](D:\a_briup_learn\Mysql\数据库事务.assets\image-20240908160000531.png)

修改

![image-20240908160143058](D:\a_briup_learn\Mysql\数据库事务.assets\image-20240908160143058.png)

此时修改数据他就不会提交

```
rollback;//返回到事务之前的状态
commit;//将事务提交
```

```
方案二：自动提交模式下开启独立事务
#也可以在自动提交模式下，开启一个事务  就是将上方与下方分隔开
START TRANSACTION;
#添加多个sql命令
#最后可以提交或者回滚
COMMIT;
ROLLBACK;
注意：不论是自动提交或者不自动提交都可以开启
```

```
方案三：DDL语句不支持事务（注意注意）
DDL:create drop alter 等创建库、创建表、删除库\表、修改库\表结构等这些语句不支持事务
只对insert、update、delete语句支持事务
truncate 表名称;情空整个表的数据，不支持事务。把表drop掉，新建一张表。
```

**事务隔离级别**

一个事务**内部**的操作及使用的数据对并发的其他事务是隔离的，**并发执行**的各个事务之间不能相互干扰。

隔离级别：一个事务与其他事务隔离的程度。级别越高，数据**一致性越好**，但**并发性能越弱**。

![ce4f1089fac2cfca436da9d427e72949](D:\a_briup_learn\Mysql\数据库事务.assets\ce4f1089fac2cfca436da9d427e72949.jpg)

> 不使用序列化：是他没有并发，一个一个来，（想想用户一个一个插入）  

**脏读：一个事务读取了另一个事务 未 提交数据**  数据上是错的、而后两者都不是数据上的错误，只是不符合数据一致性原则。

  **不可重复读：一个事务读取了另一个事务提交的修改数据**

  **幻读：一个事务读取了另一个事务提交的新增、删除的记录情况，记录数不一样，像是出现幻觉。**

> 后两者：就是做着做着突然间想起自己要修改或插入某数据，就用另一个事务

```
#修改隔离级别
set TRANSACTION_isolation='隔离级别';
#查看隔离级别
SELECT @@transacction_isolation;
```

> 比如说转钱，使用脏读，你读到他未提交的数据，然后他回滚，你最后还是没有数据，不可重复读是你在他commit之后才会读到。